<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MouseAdapterMenuAction.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">view</a> &gt; <a href="index.source.html" class="el_package">com.jsql.view.swing.list</a> &gt; <span class="el_source">MouseAdapterMenuAction.java</span></div><h1>MouseAdapterMenuAction.java</h1><pre class="source lang-java linenums">/*******************************************************************************
 * Copyhacked (H) 2012-2020.
 * This program and the accompanying materials
 * are made available under no term at all, use it like
 * you want, but share and discuss about it
 * every time possible with every body.
 * 
 * Contributors:
 *      ron190 at ymail dot com - initial implementation
 ******************************************************************************/
package com.jsql.view.swing.list;

import com.jsql.util.I18nUtil;
import com.jsql.util.LogLevelUtil;
import com.jsql.view.swing.menubar.JMenuItemWithMargin;
import com.jsql.view.swing.util.I18nViewUtil;
import com.jsql.view.swing.util.MediatorHelper;
import org.apache.logging.log4j.LogManager;
import org.apache.logging.log4j.Logger;

import javax.swing.*;
import java.awt.*;
import java.awt.event.*;
import java.util.AbstractMap.SimpleEntry;
import java.util.Arrays;
import java.util.stream.Stream;

/**
 * A Mouse action to display a popupmenu on a JList.
 */
public class MouseAdapterMenuAction extends MouseAdapter {
    
    /**
     * Log4j logger sent to view.
     */
<span class="fc" id="L36">    private static final Logger LOGGER = LogManager.getRootLogger();</span>
    
    /**
     * JList to add popupmenu.
     */
    private final DnDList dndList;
    
    /**
     * Create a popup menu for current JList item.
     * @param dndList List with action
     */
<span class="fc" id="L47">    public MouseAdapterMenuAction(DnDList dndList) {</span>
<span class="fc" id="L48">        this.dndList = dndList;</span>
<span class="fc" id="L49">    }</span>
    
    /**
     * Displays a popup menu for JList.
     * @param mouseEvent Mouse event
     */
    @SuppressWarnings(&quot;unchecked&quot;)
    public void showPopup(final MouseEvent mouseEvent) {
        
<span class="fc bfc" id="L58" title="All 2 branches covered.">        if (mouseEvent.isPopupTrigger()) {</span>
            
<span class="fc" id="L60">            JList&lt;ItemList&gt; list = (JList&lt;ItemList&gt;) mouseEvent.getSource();</span>

<span class="fc" id="L62">            JPopupMenu popupMenuList = this.initializeMenu(mouseEvent);</span>
            
<span class="fc" id="L64">            popupMenuList.applyComponentOrientation(ComponentOrientation.getOrientation(I18nUtil.getLocaleDefault()));</span>

            // Fix #26274: IllegalComponentStateException on show()
            try {
<span class="fc" id="L68">                popupMenuList.show(</span>
                    list,
<span class="pc bpc" id="L70" title="1 of 2 branches missed.">                    ComponentOrientation.RIGHT_TO_LEFT.equals(ComponentOrientation.getOrientation(I18nUtil.getLocaleDefault()))</span>
<span class="nc" id="L71">                    ? mouseEvent.getX() - popupMenuList.getWidth()</span>
<span class="fc" id="L72">                    : mouseEvent.getX(),</span>
<span class="fc" id="L73">                    mouseEvent.getY()</span>
                );
                
<span class="nc" id="L76">            } catch (IllegalComponentStateException e) {</span>
                
<span class="nc" id="L78">                LOGGER.log(LogLevelUtil.CONSOLE_JAVA, e, e);</span>
<span class="fc" id="L79">            }</span>
            
<span class="fc" id="L81">            popupMenuList.setLocation(</span>
<span class="pc bpc" id="L82" title="1 of 2 branches missed.">                ComponentOrientation.RIGHT_TO_LEFT.equals(ComponentOrientation.getOrientation(I18nUtil.getLocaleDefault()))</span>
<span class="nc" id="L83">                ? mouseEvent.getXOnScreen() - popupMenuList.getWidth()</span>
<span class="fc" id="L84">                : mouseEvent.getXOnScreen(),</span>
<span class="fc" id="L85">                mouseEvent.getYOnScreen()</span>
            );
        }
<span class="fc" id="L88">    }</span>

    private JPopupMenu initializeMenu(final MouseEvent mouseEvent) {
        
<span class="fc" id="L92">        var popupMenuList = new JPopupMenu();</span>
        
<span class="fc" id="L94">        boolean isAsian = I18nUtil.isAsian(I18nUtil.getLocaleDefault());</span>
        
<span class="fc" id="L96">        JMenuItem mnImport = new JMenuItemWithMargin();</span>
<span class="fc" id="L97">        JMenuItem mnExport = new JMenuItemWithMargin();</span>
<span class="fc" id="L98">        JMenuItem mnCut = new JMenuItemWithMargin();</span>
<span class="fc" id="L99">        JMenuItem mnCopy = new JMenuItemWithMargin();</span>
<span class="fc" id="L100">        JMenuItem mnPaste = new JMenuItemWithMargin();</span>
<span class="fc" id="L101">        JMenuItem mnDelete = new JMenuItemWithMargin();</span>
<span class="fc" id="L102">        JMenuItem mnNew = new JMenuItemWithMargin();</span>
<span class="fc" id="L103">        JMenuItem mnRestoreDefault = new JMenuItemWithMargin();</span>
<span class="fc" id="L104">        JMenuItem mnSelectAll = new JMenuItemWithMargin();</span>
        
<span class="fc" id="L106">        Stream</span>
<span class="fc" id="L107">        .of(</span>
            new SimpleEntry&lt;&gt;(mnImport, &quot;LIST_IMPORT_CONFIRM_TITLE&quot;),
            new SimpleEntry&lt;&gt;(mnExport, &quot;LIST_EXPORT_TITLE&quot;),
            new SimpleEntry&lt;&gt;(mnCut, &quot;LIST_CUT&quot;),
            new SimpleEntry&lt;&gt;(mnCopy, &quot;CONTEXT_MENU_COPY&quot;),
            new SimpleEntry&lt;&gt;(mnPaste, &quot;LIST_PASTE&quot;),
            new SimpleEntry&lt;&gt;(mnDelete, &quot;LIST_DELETE&quot;),
            new SimpleEntry&lt;&gt;(mnNew, &quot;LIST_NEW_VALUE&quot;),
            new SimpleEntry&lt;&gt;(mnRestoreDefault, &quot;LIST_RESTORE_DEFAULT&quot;),
            new SimpleEntry&lt;&gt;(mnSelectAll, &quot;CONTEXT_MENU_SELECT_ALL&quot;)
        )
<span class="fc" id="L118">        .forEach(entry -&gt; {</span>
            
<span class="fc" id="L120">            entry.getKey().setText(</span>
<span class="pc bpc" id="L121" title="1 of 2 branches missed.">                isAsian</span>
<span class="nc" id="L122">                ? I18nViewUtil.valueByKey(entry.getValue())</span>
<span class="fc" id="L123">                : I18nUtil.valueByKey(entry.getValue())</span>
            );
<span class="fc" id="L125">            entry.getKey().setName(entry.getValue());</span>
            
<span class="fc" id="L127">            I18nViewUtil.addComponentForKey(entry.getValue(), entry.getKey());</span>
<span class="fc" id="L128">        });</span>

<span class="fc" id="L130">        mnCut.setAccelerator(KeyStroke.getKeyStroke(KeyEvent.VK_X, InputEvent.CTRL_DOWN_MASK));</span>
<span class="fc" id="L131">        mnCopy.setAccelerator(KeyStroke.getKeyStroke(KeyEvent.VK_C, InputEvent.CTRL_DOWN_MASK));</span>
<span class="fc" id="L132">        mnPaste.setAccelerator(KeyStroke.getKeyStroke(KeyEvent.VK_V, InputEvent.CTRL_DOWN_MASK));</span>
<span class="fc" id="L133">        mnSelectAll.setAccelerator(KeyStroke.getKeyStroke(KeyEvent.VK_A, InputEvent.CTRL_DOWN_MASK));</span>
        
        //Create a file chooser
<span class="fc" id="L136">        final var importFileDialog = new JFileChooser(MediatorHelper.model().getMediatorUtils().getPreferencesUtil().getPathFile());</span>
<span class="fc" id="L137">        importFileDialog.setDialogTitle(I18nUtil.valueByKey(&quot;LIST_IMPORT_CONFIRM_TITLE&quot;));</span>
<span class="fc" id="L138">        importFileDialog.setMultiSelectionEnabled(true);</span>

<span class="fc" id="L140">        mnNew.addActionListener(new MenuActionNewValue(this.dndList));</span>

<span class="fc" id="L142">        mnImport.addActionListener(actionEvent -&gt; {</span>
            
<span class="nc" id="L144">            var choice = 0;</span>
            
            // Fix #1896: NullPointerException on showOpenDialog()
            // Fix #42831: ClassCastException on showOpenDialog()
            try {
<span class="nc" id="L149">                choice = importFileDialog.showOpenDialog(this.dndList.getTopLevelAncestor());</span>
                
<span class="nc" id="L151">            } catch (ClassCastException | NullPointerException e) {</span>
                
<span class="nc" id="L153">                LOGGER.log(LogLevelUtil.CONSOLE_JAVA, e, e);</span>
<span class="nc" id="L154">            }</span>
            
<span class="nc bnc" id="L156" title="All 2 branches missed.">            if (choice == JFileChooser.APPROVE_OPTION) {</span>
                
<span class="nc" id="L158">                this.dndList.dropPasteFile(</span>
<span class="nc" id="L159">                    Arrays.asList(importFileDialog.getSelectedFiles()),</span>
<span class="nc" id="L160">                    this.dndList.locationToIndex(mouseEvent.getPoint())</span>
                );
            }
<span class="nc" id="L163">        });</span>

<span class="fc" id="L165">        mnCopy.addActionListener(actionEvent -&gt; {</span>
            
<span class="nc" id="L167">            var action = this.dndList.getActionMap().get(TransferHandler.getCopyAction().getValue(Action.NAME));</span>
            
<span class="nc bnc" id="L169" title="All 2 branches missed.">            if (action != null) {</span>
                
<span class="nc" id="L171">                action.actionPerformed(</span>
                    new ActionEvent(this.dndList, ActionEvent.ACTION_PERFORMED, null)
                );
            }
<span class="nc" id="L175">        });</span>

<span class="fc" id="L177">        mnCut.addActionListener(actionEvent -&gt; {</span>
            
<span class="nc" id="L179">            var action = this.dndList.getActionMap().get(TransferHandler.getCutAction().getValue(Action.NAME));</span>
            
<span class="nc bnc" id="L181" title="All 2 branches missed.">            if (action != null) {</span>
                
<span class="nc" id="L183">                action.actionPerformed(</span>
                    new ActionEvent(this.dndList, ActionEvent.ACTION_PERFORMED, null)
                );
            }
<span class="nc" id="L187">        });</span>

<span class="fc" id="L189">        mnPaste.addActionListener(actionEvent -&gt; {</span>
            
<span class="nc" id="L191">            var action = this.dndList.getActionMap().get(TransferHandler.getPasteAction().getValue(Action.NAME));</span>
            
<span class="nc bnc" id="L193" title="All 2 branches missed.">            if (action != null) {</span>
                
<span class="nc" id="L195">                action.actionPerformed(</span>
                    new ActionEvent(this.dndList, ActionEvent.ACTION_PERFORMED, null)
                );
            }
<span class="nc" id="L199">        });</span>

<span class="pc" id="L201">        mnDelete.addActionListener(actionEvent -&gt; this.dndList.removeSelectedItem());</span>

<span class="fc" id="L203">        mnExport.addActionListener(new MenuActionExport(this.dndList));</span>

<span class="pc" id="L205">        mnRestoreDefault.addActionListener(actionEvent -&gt; this.dndList.restore());</span>

<span class="fc" id="L207">        mnSelectAll.addActionListener(actionEvent -&gt; {</span>
            
<span class="nc" id="L209">            var start = 0;</span>
<span class="nc" id="L210">            int end = this.dndList.getModel().getSize() - 1;</span>
            
<span class="nc bnc" id="L212" title="All 2 branches missed.">            if (end &gt;= 0) {</span>
                
<span class="nc" id="L214">                this.dndList.setSelectionInterval(start, end);</span>
            }
<span class="nc" id="L216">        });</span>

<span class="fc" id="L218">        popupMenuList.add(mnNew);</span>
<span class="fc" id="L219">        popupMenuList.add(new JSeparator());</span>
<span class="fc" id="L220">        popupMenuList.add(mnCut);</span>
<span class="fc" id="L221">        popupMenuList.add(mnCopy);</span>
<span class="fc" id="L222">        popupMenuList.add(mnPaste);</span>
<span class="fc" id="L223">        popupMenuList.add(mnDelete);</span>
<span class="fc" id="L224">        popupMenuList.add(new JSeparator());</span>
<span class="fc" id="L225">        popupMenuList.add(mnSelectAll);</span>
<span class="fc" id="L226">        popupMenuList.add(new JSeparator());</span>
<span class="fc" id="L227">        popupMenuList.add(mnImport);</span>
<span class="fc" id="L228">        popupMenuList.add(mnExport);</span>
<span class="fc" id="L229">        popupMenuList.add(new JSeparator());</span>
<span class="fc" id="L230">        popupMenuList.add(mnRestoreDefault);</span>
        
<span class="fc" id="L232">        return popupMenuList;</span>
    }

    @Override
    public void mousePressed(MouseEvent e) {
        
<span class="fc bfc" id="L238" title="All 2 branches covered.">        if (SwingUtilities.isRightMouseButton(e)) {</span>
            
<span class="fc" id="L240">            int clickIndex = this.dndList.locationToIndex(e.getPoint());</span>
<span class="fc" id="L241">            var containsIndex = false;</span>
            
<span class="pc bpc" id="L243" title="1 of 2 branches missed.">            for (int currentIndex: this.dndList.getSelectedIndices()) {</span>
                
<span class="pc bpc" id="L245" title="1 of 2 branches missed.">                if (currentIndex == clickIndex) {</span>
                    
<span class="fc" id="L247">                    containsIndex = true;</span>
<span class="fc" id="L248">                    break;</span>
                }
            }
            
<span class="pc bpc" id="L252" title="1 of 2 branches missed.">            if (!containsIndex) {</span>
                
<span class="nc" id="L254">                this.dndList.setSelectedIndex(clickIndex);</span>
            }
        }
        
<span class="fc" id="L258">        this.showPopup(e);</span>
<span class="fc" id="L259">    }</span>

    @Override
    public void mouseReleased(MouseEvent e) {
<span class="fc" id="L263">        this.showPopup(e);</span>
<span class="fc" id="L264">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>