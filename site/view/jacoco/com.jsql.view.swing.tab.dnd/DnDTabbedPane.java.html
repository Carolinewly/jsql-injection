<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DnDTabbedPane.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">view</a> &gt; <a href="index.source.html" class="el_package">com.jsql.view.swing.tab.dnd</a> &gt; <span class="el_source">DnDTabbedPane.java</span></div><h1>DnDTabbedPane.java</h1><pre class="source lang-java linenums">package com.jsql.view.swing.tab.dnd;

import com.jsql.view.swing.action.ActionCloseTabResult;
import com.jsql.view.swing.ui.CustomMetalTabbedPaneUI;
import com.jsql.view.swing.util.UiUtil;

import javax.swing.*;
import java.awt.*;
import java.awt.dnd.DragSource;
import java.awt.event.MouseAdapter;
import java.awt.event.MouseEvent;
import java.beans.PropertyChangeEvent;
import java.beans.PropertyChangeListener;
import java.util.Objects;
import java.util.Optional;

public class DnDTabbedPane extends JTabbedPane {
    
    private static final int SCROLL_SIZE = 20; // Test
    private static final int BUTTON_SIZE = 30; // 30 is magic number of scroll button size
    private static final int LINE_WIDTH = 3;
<span class="fc" id="L22">    private static final Rectangle RECT_BACKWARD = new Rectangle();</span>
<span class="fc" id="L23">    private static final Rectangle RECT_FORWARD = new Rectangle();</span>
<span class="fc" id="L24">    protected static final Rectangle RECT_LINE = new Rectangle();</span>
<span class="fc" id="L25">    protected int dragTabIndex = -1;</span>
    private transient DnDDropLocation dropLocation;

    public static final class DnDDropLocation extends TransferHandler.DropLocation {
        
        private final int index;
<span class="fc" id="L31">        private boolean dropable = true;</span>
        
        private DnDDropLocation(Point p, int index) {
<span class="fc" id="L34">            super(p);</span>
<span class="fc" id="L35">            this.index = index;</span>
<span class="fc" id="L36">        }</span>
        
        public int getIndex() {
<span class="fc" id="L39">            return this.index;</span>
        }
        
        public void setDroppable(boolean flag) {
<span class="fc" id="L43">            this.dropable = flag;</span>
<span class="fc" id="L44">        }</span>
        
        public boolean isDroppable() {
<span class="fc" id="L47">            return this.dropable;</span>
        }
    }
    
    private void clickArrowButton(String actionKey) {
        
<span class="nc" id="L53">        JButton scrollForwardButton = null;</span>
<span class="nc" id="L54">        JButton scrollBackwardButton = null;</span>
        
<span class="nc bnc" id="L56" title="All 2 branches missed.">        for (Component c: this.getComponents()) {</span>
            
<span class="nc bnc" id="L58" title="All 2 branches missed.">            if (c instanceof JButton) {</span>
                
<span class="nc bnc" id="L60" title="All 2 branches missed.">                if (scrollForwardButton == null) {</span>
                    
<span class="nc" id="L62">                    scrollForwardButton = (JButton) c;</span>
                    
<span class="nc bnc" id="L64" title="All 2 branches missed.">                } else if (scrollBackwardButton == null) {</span>
                    
<span class="nc" id="L66">                    scrollBackwardButton = (JButton) c;</span>
                }
            }
        }
        
<span class="nc bnc" id="L71" title="All 2 branches missed.">        JButton button = &quot;scrollTabsForwardAction&quot;.equals(actionKey) ? scrollForwardButton : scrollBackwardButton;</span>
    
<span class="nc" id="L73">        Optional</span>
<span class="nc" id="L74">        .ofNullable(button)</span>
<span class="nc" id="L75">        .filter(JButton::isEnabled)</span>
<span class="nc" id="L76">        .ifPresent(JButton::doClick);</span>
<span class="nc" id="L77">    }</span>
    
    public void autoScrollTest(Point pt) {
        
<span class="fc" id="L81">        Rectangle r = this.getTabAreaBounds();</span>
        
<span class="pc bpc" id="L83" title="1 of 2 branches missed.">        if (isTopBottomTabPlacement(this.getTabPlacement())) {</span>
            
<span class="fc" id="L85">            RECT_BACKWARD.setBounds(r.x, r.y, SCROLL_SIZE, r.height);</span>
<span class="fc" id="L86">            RECT_FORWARD.setBounds(r.x + r.width - SCROLL_SIZE - BUTTON_SIZE, r.y, SCROLL_SIZE + BUTTON_SIZE, r.height);</span>
            
        } else {
            
<span class="nc" id="L90">            RECT_BACKWARD.setBounds(r.x, r.y, r.width, SCROLL_SIZE);</span>
<span class="nc" id="L91">            RECT_FORWARD.setBounds(r.x, r.y + r.height - SCROLL_SIZE - BUTTON_SIZE, r.width, SCROLL_SIZE + BUTTON_SIZE);</span>
        }
        
<span class="pc bpc" id="L94" title="1 of 2 branches missed.">        if (RECT_BACKWARD.contains(pt)) {</span>
            
<span class="nc" id="L96">            this.clickArrowButton(&quot;scrollTabsBackwardAction&quot;);</span>
            
<span class="pc bpc" id="L98" title="1 of 2 branches missed.">        } else if (RECT_FORWARD.contains(pt)) {</span>
            
<span class="nc" id="L100">            this.clickArrowButton(&quot;scrollTabsForwardAction&quot;);</span>
        }
<span class="fc" id="L102">    }</span>
    
    protected DnDTabbedPane() {
        
<span class="fc" id="L106">        super();</span>
        
        // UIManager.put() is not enough
<span class="fc" id="L109">        this.setUI(new CustomMetalTabbedPaneUI());</span>
<span class="fc" id="L110">        this.setBorder(BorderFactory.createMatteBorder(0, 1, 0, 0, UiUtil.COLOR_COMPONENT_BORDER));</span>
        
<span class="fc" id="L112">        var h = new Handler();</span>
<span class="fc" id="L113">        this.addMouseListener(h);</span>
<span class="fc" id="L114">        this.addMouseMotionListener(h);</span>
<span class="fc" id="L115">        this.addPropertyChangeListener(h);</span>
<span class="fc" id="L116">    }</span>
    
    public DnDDropLocation dropLocationForPointDnD(Point p) {
        
<span class="pc bpc" id="L120" title="1 of 2 branches missed.">        for (var i = 0; i &lt; this.getTabCount(); i++) {</span>
            
<span class="fc bfc" id="L122" title="All 2 branches covered.">            if (this.getBoundsAt(i).contains(p)) {</span>
                
<span class="fc" id="L124">                return new DnDDropLocation(p, i);</span>
            }
        }
        
<span class="nc bnc" id="L128" title="All 2 branches missed.">        if (this.getTabAreaBounds().contains(p)) {</span>
            
<span class="nc" id="L130">            return new DnDDropLocation(p, this.getTabCount());</span>
        }
        
<span class="nc" id="L133">        return new DnDDropLocation(p, -1);</span>
    }
    
    public void setDropLocation(TransferHandler.DropLocation location, boolean forDrop) {
        
<span class="fc" id="L138">        DnDDropLocation old = this.dropLocation;</span>
        
<span class="pc bpc" id="L140" title="1 of 4 branches missed.">        if (Objects.isNull(location) || !forDrop) {</span>
            
<span class="fc" id="L142">            this.dropLocation = new DnDDropLocation(new Point(), -1);</span>
            
<span class="pc bpc" id="L144" title="1 of 2 branches missed.">        } else if (location instanceof DnDDropLocation) {</span>
            
<span class="fc" id="L146">            this.dropLocation = (DnDDropLocation) location;</span>
        }
        
<span class="fc" id="L149">        this.firePropertyChange(&quot;dropLocation&quot;, old, this.dropLocation);</span>
<span class="fc" id="L150">    }</span>
    
    public void exportTab(int dragIndex, JTabbedPane target, int targetIndex) {
        
<span class="nc" id="L154">        var cmp = this.getComponentAt(dragIndex);</span>
<span class="nc" id="L155">        var tab = this.getTabComponentAt(dragIndex);</span>
<span class="nc" id="L156">        String title = this.getTitleAt(dragIndex);</span>
<span class="nc" id="L157">        var icon = this.getIconAt(dragIndex);</span>
<span class="nc" id="L158">        String tip = this.getToolTipTextAt(dragIndex);</span>
<span class="nc" id="L159">        boolean isEnabled = this.isEnabledAt(dragIndex);</span>
        
<span class="nc" id="L161">        this.remove(dragIndex);</span>
<span class="nc" id="L162">        target.insertTab(title, icon, cmp, tip, targetIndex);</span>
<span class="nc" id="L163">        target.setEnabledAt(targetIndex, isEnabled);</span>

<span class="nc" id="L165">        target.setTabComponentAt(targetIndex, tab);</span>
<span class="nc" id="L166">        target.setSelectedIndex(targetIndex);</span>
        
<span class="nc bnc" id="L168" title="All 2 branches missed.">        if (tab instanceof JComponent) {</span>
            
<span class="nc" id="L170">            ((JComponent) tab).scrollRectToVisible(tab.getBounds());</span>
        }
<span class="nc" id="L172">    }</span>
    
    public void convertTab(int prev, int next) {
        
<span class="fc" id="L176">        var cmp = this.getComponentAt(prev);</span>
<span class="fc" id="L177">        var tab = this.getTabComponentAt(prev);</span>
<span class="fc" id="L178">        String title = this.getTitleAt(prev);</span>
<span class="fc" id="L179">        var icon = this.getIconAt(prev);</span>
<span class="fc" id="L180">        String tip = this.getToolTipTextAt(prev);</span>
<span class="fc" id="L181">        boolean isEnabled = this.isEnabledAt(prev);</span>
<span class="pc bpc" id="L182" title="1 of 2 branches missed.">        int tgtindex = prev &gt; next ? next : next - 1;</span>
        
<span class="fc" id="L184">        this.remove(prev);</span>
<span class="fc" id="L185">        this.insertTab(title, icon, cmp, tip, tgtindex);</span>
<span class="fc" id="L186">        this.setEnabledAt(tgtindex, isEnabled);</span>
        
        // When you drag'n'drop a disabled tab, it finishes enabled and selected.
        // pointed out by dlorde
<span class="pc bpc" id="L190" title="1 of 2 branches missed.">        if (isEnabled) {</span>
            
<span class="fc" id="L192">            this.setSelectedIndex(tgtindex);</span>
        }
        
        // I have a component in all tabs (jlabel with an X to close the tab) and when i move a tab the component disappear.
        // pointed out by Daniel Dario Morales Salas
<span class="fc" id="L197">        this.setTabComponentAt(tgtindex, tab);</span>
<span class="fc" id="L198">    }</span>
    
    public Optional&lt;Rectangle&gt; getDropLineRect() {
        
<span class="fc" id="L202">        int index =</span>
            Optional
<span class="fc" id="L204">            .ofNullable(this.getDropLocation())</span>
<span class="fc" id="L205">            .filter(DnDDropLocation::isDroppable)</span>
<span class="fc" id="L206">            .map(DnDDropLocation::getIndex)</span>
<span class="fc" id="L207">            .orElse(-1);</span>
        
<span class="fc bfc" id="L209" title="All 2 branches covered.">        if (index &lt; 0) {</span>
            
<span class="fc" id="L211">            RECT_LINE.setBounds(0, 0, 0, 0);</span>
            
<span class="fc" id="L213">            return Optional.empty();</span>
        }
        
<span class="fc" id="L216">        int a = Math.min(index, 1);</span>
<span class="fc" id="L217">        Rectangle r = this.getBoundsAt(a * (index - 1));</span>
        
<span class="pc bpc" id="L219" title="1 of 2 branches missed.">        if (isTopBottomTabPlacement(this.getTabPlacement())) {</span>
            
<span class="fc" id="L221">            RECT_LINE.setBounds(r.x - LINE_WIDTH / 2 + r.width * a, r.y, LINE_WIDTH, r.height);</span>
            
        } else {
            
<span class="nc" id="L225">            RECT_LINE.setBounds(r.x, r.y - LINE_WIDTH / 2 + r.height * a, r.width, LINE_WIDTH);</span>
        }
        
<span class="fc" id="L228">        return Optional.of(RECT_LINE);</span>
    }
    
    public Rectangle getTabAreaBounds() {
        
<span class="fc" id="L233">        Rectangle tabbedRect = this.getBounds();</span>
<span class="fc" id="L234">        int xx = tabbedRect.x;</span>
<span class="fc" id="L235">        int yy = tabbedRect.y;</span>
        
<span class="fc" id="L237">        Rectangle compRect = Optional.ofNullable(this.getSelectedComponent()).map(Component::getBounds).orElseGet(Rectangle::new);</span>
<span class="fc" id="L238">        int tabPlacement = this.getTabPlacement();</span>
        
<span class="pc bpc" id="L240" title="1 of 2 branches missed.">        if (isTopBottomTabPlacement(tabPlacement)) {</span>
            
<span class="fc" id="L242">            tabbedRect.height = tabbedRect.height - compRect.height;</span>
            
<span class="pc bpc" id="L244" title="1 of 2 branches missed.">            if (tabPlacement == BOTTOM) {</span>
                
<span class="nc" id="L246">                tabbedRect.y += compRect.y + compRect.height;</span>
            }
            
        } else {
            
<span class="nc" id="L251">            tabbedRect.width = tabbedRect.width - compRect.width;</span>
            
<span class="nc bnc" id="L253" title="All 2 branches missed.">            if (tabPlacement == RIGHT) {</span>
                
<span class="nc" id="L255">                tabbedRect.x += compRect.x + compRect.width;</span>
            }
        }
        
<span class="fc" id="L259">        tabbedRect.translate(-xx, -yy);</span>
        
<span class="fc" id="L261">        return tabbedRect;</span>
    }

    public static boolean isTopBottomTabPlacement(int tabPlacement) {
        
<span class="pc bpc" id="L266" title="3 of 4 branches missed.">        return tabPlacement == SwingConstants.TOP || tabPlacement == SwingConstants.BOTTOM;</span>
    }

<span class="fc" id="L269">    private class Handler extends MouseAdapter implements PropertyChangeListener { // , BeforeDrag</span>
        
        private Point startPt;
<span class="fc" id="L272">        private final int gestureMotionThreshold = DragSource.getDragThreshold();</span>

        private void repaintDropLocation() {
            
<span class="fc" id="L276">            Component c = DnDTabbedPane.this.getRootPane().getGlassPane();</span>
            
<span class="pc bpc" id="L278" title="1 of 2 branches missed.">            if (c instanceof GhostGlassPane) {</span>
                
<span class="fc" id="L280">                GhostGlassPane glassPane = (GhostGlassPane) c;</span>
<span class="fc" id="L281">                glassPane.setTargetTabbedPane(DnDTabbedPane.this);</span>
<span class="fc" id="L282">                glassPane.repaint();</span>
            }
<span class="fc" id="L284">        }</span>
        
        // PropertyChangeListener
        @Override
        public void propertyChange(PropertyChangeEvent e) {
            
<span class="fc" id="L290">            String propertyName = e.getPropertyName();</span>
<span class="fc bfc" id="L291" title="All 2 branches covered.">            if (&quot;dropLocation&quot;.equals(propertyName)) {</span>
                
<span class="fc" id="L293">                this.repaintDropLocation();</span>
            }
<span class="fc" id="L295">        }</span>
        
        // MouseListener
        @Override
        public void mousePressed(MouseEvent e) {
            
<span class="fc" id="L301">            DnDTabbedPane src = (DnDTabbedPane) e.getComponent();</span>
<span class="fc bfc" id="L302" title="All 2 branches covered.">            boolean isOnlyOneTab = src.getTabCount() &lt;= 1;</span>
            
<span class="fc bfc" id="L304" title="All 2 branches covered.">            if (isOnlyOneTab) {</span>
                
<span class="fc" id="L306">                this.startPt = null;</span>
<span class="fc" id="L307">                return;</span>
            }
            
<span class="fc" id="L310">            var tabPt = e.getPoint();</span>
<span class="fc" id="L311">            int idx = src.indexAtLocation(tabPt.x, tabPt.y);</span>
            
            // disabled tab, null component problem.
            // pointed out by daryl. NullPointerException: i.e. addTab(&quot;Tab&quot;, null)
<span class="pc bpc" id="L315" title="3 of 6 branches missed.">            boolean flag = idx &lt; 0 || !src.isEnabledAt(idx) || Objects.isNull(src.getComponentAt(idx));</span>
            
<span class="pc bpc" id="L317" title="1 of 2 branches missed.">            this.startPt = flag ? null : tabPt;</span>
<span class="fc" id="L318">        }</span>
        
        @Override
        public void mouseDragged(MouseEvent e) {
            
<span class="fc" id="L323">            var tabPt = e.getPoint();</span>
            
<span class="pc bpc" id="L325" title="2 of 4 branches missed.">            if (Objects.nonNull(this.startPt) &amp;&amp; this.startPt.distance(tabPt) &gt; this.gestureMotionThreshold) {</span>
                
<span class="fc" id="L327">                DnDTabbedPane src = (DnDTabbedPane) e.getComponent();</span>
<span class="fc" id="L328">                var th = src.getTransferHandler();</span>
<span class="fc" id="L329">                DnDTabbedPane.this.dragTabIndex = src.indexAtLocation(tabPt.x, tabPt.y);</span>
                
                // Unhandled NoClassDefFoundError #56620: Could not initialize class java.awt.dnd.DragSource
<span class="fc" id="L332">                th.exportAsDrag(src, e, TransferHandler.MOVE);</span>
                
<span class="fc" id="L334">                RECT_LINE.setBounds(0, 0, 0, 0);</span>
<span class="fc" id="L335">                src.getRootPane().getGlassPane().setVisible(true);</span>
<span class="fc" id="L336">                src.setDropLocation(new DnDDropLocation(tabPt, -1), true);</span>
                
<span class="fc" id="L338">                this.startPt = null;</span>
            }
<span class="fc" id="L340">        }</span>

        @Override
        public void mouseClicked(MouseEvent e) {
            
<span class="fc" id="L345">            var tabPt = e.getPoint();</span>
<span class="fc" id="L346">            JTabbedPane src = (JTabbedPane) e.getSource();</span>
            
<span class="fc" id="L348">            int i = src.indexAtLocation(tabPt.x, tabPt.y);</span>
            
<span class="pc bpc" id="L350" title="2 of 4 branches missed.">            if (-1 &lt; i &amp;&amp; e.getButton() == MouseEvent.BUTTON2) {</span>
                
<span class="nc" id="L352">                ActionCloseTabResult.perform(i);</span>
            }
<span class="fc" id="L354">        }</span>
    }
    
    public final DnDDropLocation getDropLocation() {
<span class="fc" id="L358">        return this.dropLocation;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>