<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MouseAdapterMenuAction.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">view</a> &gt; <a href="index.source.html" class="el_package">com.jsql.view.swing.list</a> &gt; <span class="el_source">MouseAdapterMenuAction.java</span></div><h1>MouseAdapterMenuAction.java</h1><pre class="source lang-java linenums">/*******************************************************************************
 * Copyhacked (H) 2012-2020.
 * This program and the accompanying materials
 * are made available under no term at all, use it like
 * you want, but share and discuss about it
 * every time possible with every body.
 * 
 * Contributors:
 *      ron190 at ymail dot com - initial implementation
 ******************************************************************************/
package com.jsql.view.swing.list;

import com.jsql.util.I18nUtil;
import com.jsql.util.LogLevelUtil;
import com.jsql.view.swing.menubar.JMenuItemWithMargin;
import com.jsql.view.swing.util.I18nViewUtil;
import com.jsql.view.swing.util.MediatorHelper;
import org.apache.logging.log4j.LogManager;
import org.apache.logging.log4j.Logger;

import javax.swing.*;
import java.awt.*;
import java.awt.event.*;
import java.util.AbstractMap.SimpleEntry;
import java.util.Arrays;
import java.util.stream.Stream;

/**
 * A Mouse action to display a popupmenu on a JList.
 */
public class MouseAdapterMenuAction extends MouseAdapter {
    
    /**
     * Log4j logger sent to view.
     */
<span class="fc" id="L36">    private static final Logger LOGGER = LogManager.getRootLogger();</span>
    
    /**
     * JList to add popupmenu.
     */
    private final DnDList dndList;
    
    /**
     * Create a popup menu for current JList item.
     * @param dndList List with action
     */
<span class="fc" id="L47">    public MouseAdapterMenuAction(DnDList dndList) {</span>
<span class="fc" id="L48">        this.dndList = dndList;</span>
<span class="fc" id="L49">    }</span>
    
    /**
     * Displays a popup menu for JList.
     * @param mouseEvent Mouse event
     */
    @SuppressWarnings(&quot;unchecked&quot;)
    public void showPopup(final MouseEvent mouseEvent) {
        
<span class="fc bfc" id="L58" title="All 2 branches covered.">        if (mouseEvent.isPopupTrigger()) {</span>
            
<span class="fc" id="L60">            JList&lt;ItemList&gt; list = (JList&lt;ItemList&gt;) mouseEvent.getSource();</span>

<span class="fc" id="L62">            JPopupMenu popupMenuList = this.initializeMenu(mouseEvent);</span>
            
<span class="fc" id="L64">            popupMenuList.applyComponentOrientation(ComponentOrientation.getOrientation(I18nUtil.getLocaleDefault()));</span>

            // Fix #26274: IllegalComponentStateException on show()
            try {
<span class="fc" id="L68">                popupMenuList.show(</span>
                    list,
<span class="pc bpc" id="L70" title="1 of 2 branches missed.">                    ComponentOrientation.RIGHT_TO_LEFT.equals(ComponentOrientation.getOrientation(I18nUtil.getLocaleDefault()))</span>
<span class="nc" id="L71">                    ? mouseEvent.getX() - popupMenuList.getWidth()</span>
<span class="fc" id="L72">                    : mouseEvent.getX(),</span>
<span class="fc" id="L73">                    mouseEvent.getY()</span>
                );
<span class="nc" id="L75">            } catch (IllegalComponentStateException e) {</span>
<span class="nc" id="L76">                LOGGER.log(LogLevelUtil.CONSOLE_JAVA, e, e);</span>
<span class="fc" id="L77">            }</span>
            
<span class="fc" id="L79">            popupMenuList.setLocation(</span>
<span class="pc bpc" id="L80" title="1 of 2 branches missed.">                ComponentOrientation.RIGHT_TO_LEFT.equals(ComponentOrientation.getOrientation(I18nUtil.getLocaleDefault()))</span>
<span class="nc" id="L81">                ? mouseEvent.getXOnScreen() - popupMenuList.getWidth()</span>
<span class="fc" id="L82">                : mouseEvent.getXOnScreen(),</span>
<span class="fc" id="L83">                mouseEvent.getYOnScreen()</span>
            );
        }
<span class="fc" id="L86">    }</span>

    private JPopupMenu initializeMenu(final MouseEvent mouseEvent) {
        
<span class="fc" id="L90">        var popupMenuList = new JPopupMenu();</span>
        
<span class="fc" id="L92">        boolean isAsian = I18nUtil.isAsian(I18nUtil.getLocaleDefault());</span>
        
<span class="fc" id="L94">        JMenuItem mnImport = new JMenuItemWithMargin();</span>
<span class="fc" id="L95">        JMenuItem mnExport = new JMenuItemWithMargin();</span>
<span class="fc" id="L96">        JMenuItem mnCut = new JMenuItemWithMargin();</span>
<span class="fc" id="L97">        JMenuItem mnCopy = new JMenuItemWithMargin();</span>
<span class="fc" id="L98">        JMenuItem mnPaste = new JMenuItemWithMargin();</span>
<span class="fc" id="L99">        JMenuItem mnDelete = new JMenuItemWithMargin();</span>
<span class="fc" id="L100">        JMenuItem mnNew = new JMenuItemWithMargin();</span>
<span class="fc" id="L101">        JMenuItem mnRestoreDefault = new JMenuItemWithMargin();</span>
<span class="fc" id="L102">        JMenuItem mnSelectAll = new JMenuItemWithMargin();</span>
        
<span class="fc" id="L104">        Stream.of(</span>
            new SimpleEntry&lt;&gt;(mnImport, &quot;LIST_IMPORT_CONFIRM_TITLE&quot;),
            new SimpleEntry&lt;&gt;(mnExport, &quot;LIST_EXPORT_TITLE&quot;),
            new SimpleEntry&lt;&gt;(mnCut, &quot;LIST_CUT&quot;),
            new SimpleEntry&lt;&gt;(mnCopy, &quot;CONTEXT_MENU_COPY&quot;),
            new SimpleEntry&lt;&gt;(mnPaste, &quot;LIST_PASTE&quot;),
            new SimpleEntry&lt;&gt;(mnDelete, &quot;LIST_DELETE&quot;),
            new SimpleEntry&lt;&gt;(mnNew, &quot;LIST_NEW_VALUE&quot;),
            new SimpleEntry&lt;&gt;(mnRestoreDefault, &quot;LIST_RESTORE_DEFAULT&quot;),
            new SimpleEntry&lt;&gt;(mnSelectAll, &quot;CONTEXT_MENU_SELECT_ALL&quot;)
        )
<span class="fc" id="L115">        .forEach(entry -&gt; {</span>
            
<span class="fc" id="L117">            entry.getKey().setText(</span>
<span class="pc bpc" id="L118" title="1 of 2 branches missed.">                isAsian</span>
<span class="nc" id="L119">                ? I18nViewUtil.valueByKey(entry.getValue())</span>
<span class="fc" id="L120">                : I18nUtil.valueByKey(entry.getValue())</span>
            );
<span class="fc" id="L122">            entry.getKey().setName(entry.getValue());</span>
            
<span class="fc" id="L124">            I18nViewUtil.addComponentForKey(entry.getValue(), entry.getKey());</span>
<span class="fc" id="L125">        });</span>

<span class="fc" id="L127">        mnCut.setAccelerator(KeyStroke.getKeyStroke(KeyEvent.VK_X, InputEvent.CTRL_DOWN_MASK));</span>
<span class="fc" id="L128">        mnCopy.setAccelerator(KeyStroke.getKeyStroke(KeyEvent.VK_C, InputEvent.CTRL_DOWN_MASK));</span>
<span class="fc" id="L129">        mnPaste.setAccelerator(KeyStroke.getKeyStroke(KeyEvent.VK_V, InputEvent.CTRL_DOWN_MASK));</span>
<span class="fc" id="L130">        mnSelectAll.setAccelerator(KeyStroke.getKeyStroke(KeyEvent.VK_A, InputEvent.CTRL_DOWN_MASK));</span>
        
        //Create a file chooser
<span class="fc" id="L133">        final var importFileDialog = new JFileChooser(MediatorHelper.model().getMediatorUtils().getPreferencesUtil().getPathFile());</span>
<span class="fc" id="L134">        importFileDialog.setDialogTitle(I18nUtil.valueByKey(&quot;LIST_IMPORT_CONFIRM_TITLE&quot;));</span>
<span class="fc" id="L135">        importFileDialog.setMultiSelectionEnabled(true);</span>

<span class="fc" id="L137">        mnNew.addActionListener(new MenuActionNewValue(this.dndList));</span>

<span class="fc" id="L139">        mnImport.addActionListener(actionEvent -&gt; {</span>
            
<span class="nc" id="L141">            var choice = 0;</span>
            
            // Fix #1896: NullPointerException on showOpenDialog()
            // Fix #42831: ClassCastException on showOpenDialog()
            try {
<span class="nc" id="L146">                choice = importFileDialog.showOpenDialog(this.dndList.getTopLevelAncestor());</span>
<span class="nc" id="L147">            } catch (ClassCastException | NullPointerException e) {</span>
<span class="nc" id="L148">                LOGGER.log(LogLevelUtil.CONSOLE_JAVA, e, e);</span>
<span class="nc" id="L149">            }</span>
            
<span class="nc bnc" id="L151" title="All 2 branches missed.">            if (choice == JFileChooser.APPROVE_OPTION) {</span>
                
<span class="nc" id="L153">                this.dndList.dropPasteFile(</span>
<span class="nc" id="L154">                    Arrays.asList(importFileDialog.getSelectedFiles()),</span>
<span class="nc" id="L155">                    this.dndList.locationToIndex(mouseEvent.getPoint())</span>
                );
            }
<span class="nc" id="L158">        });</span>

<span class="fc" id="L160">        mnCopy.addActionListener(actionEvent -&gt; {</span>
            
<span class="nc" id="L162">            var action = this.dndList.getActionMap().get(TransferHandler.getCopyAction().getValue(Action.NAME));</span>
            
<span class="nc bnc" id="L164" title="All 2 branches missed.">            if (action != null) {</span>
<span class="nc" id="L165">                action.actionPerformed(</span>
                    new ActionEvent(this.dndList, ActionEvent.ACTION_PERFORMED, null)
                );
            }
<span class="nc" id="L169">        });</span>

<span class="fc" id="L171">        mnCut.addActionListener(actionEvent -&gt; {</span>
            
<span class="nc" id="L173">            var action = this.dndList.getActionMap().get(TransferHandler.getCutAction().getValue(Action.NAME));</span>
            
<span class="nc bnc" id="L175" title="All 2 branches missed.">            if (action != null) {</span>
<span class="nc" id="L176">                action.actionPerformed(</span>
                    new ActionEvent(this.dndList, ActionEvent.ACTION_PERFORMED, null)
                );
            }
<span class="nc" id="L180">        });</span>

<span class="fc" id="L182">        mnPaste.addActionListener(actionEvent -&gt; {</span>
            
<span class="nc" id="L184">            var action = this.dndList.getActionMap().get(TransferHandler.getPasteAction().getValue(Action.NAME));</span>
            
<span class="nc bnc" id="L186" title="All 2 branches missed.">            if (action != null) {</span>
<span class="nc" id="L187">                action.actionPerformed(</span>
                    new ActionEvent(this.dndList, ActionEvent.ACTION_PERFORMED, null)
                );
            }
<span class="nc" id="L191">        });</span>

<span class="pc" id="L193">        mnDelete.addActionListener(actionEvent -&gt; this.dndList.removeSelectedItem());</span>
<span class="fc" id="L194">        mnExport.addActionListener(new MenuActionExport(this.dndList));</span>
<span class="pc" id="L195">        mnRestoreDefault.addActionListener(actionEvent -&gt; this.dndList.restore());</span>
<span class="fc" id="L196">        mnSelectAll.addActionListener(actionEvent -&gt; {</span>
            
<span class="nc" id="L198">            var start = 0;</span>
<span class="nc" id="L199">            int end = this.dndList.getModel().getSize() - 1;</span>
            
<span class="nc bnc" id="L201" title="All 2 branches missed.">            if (end &gt;= 0) {</span>
<span class="nc" id="L202">                this.dndList.setSelectionInterval(start, end);</span>
            }
<span class="nc" id="L204">        });</span>

<span class="fc" id="L206">        popupMenuList.add(mnNew);</span>
<span class="fc" id="L207">        popupMenuList.add(new JSeparator());</span>
<span class="fc" id="L208">        popupMenuList.add(mnCut);</span>
<span class="fc" id="L209">        popupMenuList.add(mnCopy);</span>
<span class="fc" id="L210">        popupMenuList.add(mnPaste);</span>
<span class="fc" id="L211">        popupMenuList.add(mnDelete);</span>
<span class="fc" id="L212">        popupMenuList.add(new JSeparator());</span>
<span class="fc" id="L213">        popupMenuList.add(mnSelectAll);</span>
<span class="fc" id="L214">        popupMenuList.add(new JSeparator());</span>
<span class="fc" id="L215">        popupMenuList.add(mnImport);</span>
<span class="fc" id="L216">        popupMenuList.add(mnExport);</span>
<span class="fc" id="L217">        popupMenuList.add(new JSeparator());</span>
<span class="fc" id="L218">        popupMenuList.add(mnRestoreDefault);</span>
        
<span class="fc" id="L220">        return popupMenuList;</span>
    }

    @Override
    public void mousePressed(MouseEvent e) {
        
<span class="fc bfc" id="L226" title="All 2 branches covered.">        if (SwingUtilities.isRightMouseButton(e)) {</span>
            
<span class="fc" id="L228">            int clickIndex = this.dndList.locationToIndex(e.getPoint());</span>
<span class="fc" id="L229">            var containsIndex = false;</span>
            
<span class="pc bpc" id="L231" title="1 of 2 branches missed.">            for (int currentIndex: this.dndList.getSelectedIndices()) {</span>
<span class="pc bpc" id="L232" title="1 of 2 branches missed.">                if (currentIndex == clickIndex) {</span>
                    
<span class="fc" id="L234">                    containsIndex = true;</span>
<span class="fc" id="L235">                    break;</span>
                }
            }
            
<span class="pc bpc" id="L239" title="1 of 2 branches missed.">            if (!containsIndex) {</span>
<span class="nc" id="L240">                this.dndList.setSelectedIndex(clickIndex);</span>
            }
        }
        
<span class="fc" id="L244">        this.showPopup(e);</span>
<span class="fc" id="L245">    }</span>

    @Override
    public void mouseReleased(MouseEvent e) {
<span class="fc" id="L249">        this.showPopup(e);</span>
<span class="fc" id="L250">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>