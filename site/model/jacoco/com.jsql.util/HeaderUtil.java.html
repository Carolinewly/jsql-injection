<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>HeaderUtil.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">model</a> &gt; <a href="index.source.html" class="el_package">com.jsql.util</a> &gt; <span class="el_source">HeaderUtil.java</span></div><h1>HeaderUtil.java</h1><pre class="source lang-java linenums">package com.jsql.util;

import com.jsql.model.InjectionModel;
import com.jsql.model.bean.util.Header;
import com.jsql.model.bean.util.Interaction;
import com.jsql.model.bean.util.Request;
import com.jsql.model.exception.JSqlException;
import org.apache.logging.log4j.LogManager;
import org.apache.logging.log4j.Logger;

import java.io.IOException;
import java.net.HttpCookie;
import java.net.URLEncoder;
import java.net.http.HttpRequest.Builder;
import java.net.http.HttpResponse;
import java.net.http.HttpResponse.BodyHandlers;
import java.nio.charset.StandardCharsets;
import java.text.DecimalFormat;
import java.util.AbstractMap.SimpleEntry;
import java.util.EnumMap;
import java.util.List;
import java.util.Map;
import java.util.regex.Pattern;
import java.util.stream.Collectors;
import java.util.stream.Stream;

public class HeaderUtil {
    
    /**
     * Log4j logger sent to view.
     */
<span class="fc" id="L32">    private static final Logger LOGGER = LogManager.getRootLogger();</span>
    
    public static final String CONTENT_TYPE_REQUEST = &quot;Content-Type&quot;;
    public static final String WWW_AUTHENTICATE_RESPONSE = &quot;www-authenticate&quot;;
    private static final String REGEX_HTTP_STATUS = &quot;4\\d\\d&quot;;
    private static final String FOUND_STATUS_HTTP = &quot;Found status HTTP&quot;;

    private final InjectionModel injectionModel;
    
<span class="fc" id="L41">    public HeaderUtil(InjectionModel injectionModel) {</span>
        
<span class="fc" id="L43">        this.injectionModel = injectionModel;</span>
<span class="fc" id="L44">    }</span>

    /**
     * Parse the header component and decode any character of the form %xy
     * except for cookie
     * @param httpRequest where decoded value will be set
     * @param header string to decode
     */
    public static void sanitizeHeaders(Builder httpRequest, SimpleEntry&lt;String, String&gt; header) throws JSqlException {
        
<span class="fc" id="L54">        String keyHeader = header.getKey().trim();</span>
<span class="fc" id="L55">        String valueHeader = header.getValue().trim();</span>

<span class="fc bfc" id="L57" title="All 4 branches covered.">        if (&quot;cookie&quot;.equalsIgnoreCase(keyHeader) &amp;&amp; Pattern.compile(&quot;.+=.*&quot;).matcher(valueHeader).find()) {</span>
            // Encode cookies to double quotes: Cookie: key=&quot;&lt;value&gt;&quot;
<span class="fc" id="L59">            List&lt;String&gt; cookies = Stream.of(valueHeader.split(&quot;;&quot;))</span>
<span class="pc bpc" id="L60" title="1 of 4 branches missed.">                .filter(value -&gt; value != null &amp;&amp; value.contains(&quot;=&quot;))</span>
<span class="fc" id="L61">                .map(cookie -&gt; cookie.split(&quot;=&quot;, 2))</span>
<span class="fc" id="L62">                .map(arrayEntry -&gt; arrayEntry[0].trim() + &quot;=&quot; + (</span>
<span class="pc bpc" id="L63" title="1 of 2 branches missed.">                    arrayEntry[1] == null</span>
<span class="nc" id="L64">                    ? &quot;&quot;</span>
                    // Url encode: new cookie RFC restricts chars to non ()&lt;&gt;@,;:\&quot;/[]?={} =&gt; server must url decode the request
<span class="fc" id="L66">                    : URLEncoder.encode(</span>
<span class="fc" id="L67">                        arrayEntry[1].trim().replace(&quot;+&quot;, &quot;%2B&quot;),</span>
                        StandardCharsets.UTF_8
                    )
                ))
<span class="fc" id="L71">                .collect(Collectors.toList());</span>
<span class="fc" id="L72">            valueHeader = String.join(&quot;; &quot;, cookies);</span>
        }

        try {
<span class="fc" id="L76">            httpRequest.setHeader(</span>
                keyHeader,
<span class="fc" id="L78">                valueHeader.replaceAll(&quot;[^\\p{ASCII}]&quot;, &quot;&quot;)</span>
            );
<span class="nc" id="L80">        } catch (IllegalArgumentException e) {</span>
<span class="nc" id="L81">            throw new JSqlException(e);</span>
<span class="fc" id="L82">        }</span>
<span class="fc" id="L83">    }</span>

    /**
     * Verify the headers received after a request, detect authentication response and
     * send the headers to the view.
     * @param httpRequestBuilder calls URL
     * @param body 
     * @return httpResponse with response headers
     * @throws IOException when an error occurs during connection
     */
    public HttpResponse&lt;String&gt; checkResponseHeader(Builder httpRequestBuilder, String body) throws IOException, InterruptedException {
        
<span class="fc" id="L95">        var httpRequest = httpRequestBuilder.build();</span>
<span class="fc" id="L96">        HttpResponse&lt;String&gt; httpResponse = this.injectionModel.getMediatorUtils().getConnectionUtil().getHttpClient().send(</span>
            httpRequest,
<span class="fc" id="L98">            BodyHandlers.ofString()</span>
        );
<span class="fc" id="L100">        String pageSource = httpResponse.body();</span>
        
<span class="fc" id="L102">        Map&lt;String, String&gt; mapResponseHeaders = ConnectionUtil.getHeadersMap(httpResponse);</span>
        
<span class="fc" id="L104">        var responseCode = Integer.toString(httpResponse.statusCode());</span>

<span class="fc" id="L106">        List&lt;HttpCookie&gt; cookies = this.injectionModel.getMediatorUtils().getConnectionUtil().getCookieManager().getCookieStore().getCookies();</span>
<span class="fc bfc" id="L107" title="All 2 branches covered.">        if (!cookies.isEmpty()) {</span>
<span class="fc" id="L108">            LOGGER.info(&quot;Cookies set by host: {}&quot;, cookies);</span>
        }

<span class="fc" id="L111">        this.checkResponse(responseCode, mapResponseHeaders);</span>
        
<span class="fc" id="L113">        this.checkStatus(httpResponse);</span>
        
<span class="fc" id="L115">        this.injectionModel.getMediatorUtils().getFormUtil().parseForms(httpResponse.statusCode(), pageSource);</span>

<span class="fc" id="L117">        this.injectionModel.getMediatorUtils().getCsrfUtil().parseForCsrfToken(pageSource, mapResponseHeaders);</span>

<span class="fc" id="L119">        this.injectionModel.getMediatorUtils().getDigestUtil().parseWwwAuthenticate(mapResponseHeaders);</span>

<span class="fc" id="L121">        Map&lt;Header, Object&gt; msgHeader = new EnumMap&lt;&gt;(Header.class);</span>
        
<span class="fc" id="L123">        int sizeHeaders = mapResponseHeaders.keySet()</span>
<span class="fc" id="L124">            .stream()</span>
<span class="fc" id="L125">            .map(key -&gt; mapResponseHeaders.get(key).length() + key.length())</span>
<span class="fc" id="L126">            .mapToInt(Integer::intValue)</span>
<span class="fc" id="L127">            .sum();</span>
        
<span class="fc" id="L129">        float size = (float) (pageSource.length() + sizeHeaders) / 1024;</span>
<span class="fc" id="L130">        var decimalFormat = new DecimalFormat(&quot;0.000&quot;);</span>
<span class="fc" id="L131">        msgHeader.put(Header.PAGE_SIZE, decimalFormat.format(size));</span>

<span class="fc" id="L133">        msgHeader.put(Header.URL, httpRequest.uri().toURL().toString());</span>
<span class="fc" id="L134">        msgHeader.put(Header.POST, body);</span>
<span class="fc" id="L135">        msgHeader.put(Header.HEADER, ConnectionUtil.getHeadersMap(httpRequest.headers()));</span>
<span class="fc" id="L136">        msgHeader.put(Header.RESPONSE, mapResponseHeaders);</span>
<span class="fc" id="L137">        msgHeader.put(Header.SOURCE, pageSource);</span>
<span class="fc" id="L138">        msgHeader.put(Header.METADATA_STRATEGY, &quot;#none&quot;);</span>
<span class="fc" id="L139">        msgHeader.put(Header.METADATA_PROCESS, &quot;test#conn&quot;);</span>
        
        // Inform the view about the log info
<span class="fc" id="L142">        var request = new Request();</span>
<span class="fc" id="L143">        request.setMessage(Interaction.MESSAGE_HEADER);</span>
<span class="fc" id="L144">        request.setParameters(msgHeader);</span>
<span class="fc" id="L145">        this.injectionModel.sendToViews(request);</span>
        
<span class="fc" id="L147">        return httpResponse;</span>
    }

    private void checkStatus(HttpResponse&lt;String&gt; response) {

<span class="fc bfc" id="L152" title="All 2 branches covered.">        if (response.statusCode() &gt;= 400) {</span>

<span class="fc bfc" id="L154" title="All 2 branches covered.">            if (this.injectionModel.getMediatorUtils().getPreferencesUtil().isNotTestingConnection()) {</span>

<span class="fc" id="L156">                LOGGER.log(LogLevelUtil.CONSOLE_SUCCESS, &quot;Connection test disabled, skipping error {}...&quot;, response.statusCode());</span>

            } else {

<span class="fc" id="L160">                LOGGER.log(LogLevelUtil.CONSOLE_INFORM, &quot;Try with option 'Disable connection test' to skip HTTP error {}&quot;, response.statusCode());</span>
            }
        }
<span class="fc" id="L163">    }</span>

    private void checkResponse(String responseCode, Map&lt;String, String&gt; mapResponse) {
        
<span class="pc bpc" id="L167" title="1 of 2 branches missed.">        if (this.isBasicAuth(responseCode, mapResponse)) {</span>
            
<span class="nc" id="L169">            LOGGER.log(</span>
                LogLevelUtil.CONSOLE_ERROR,
                &quot;Basic Authentication detected: &quot;
                + &quot;set authentication in preferences, &quot;
                + &quot;or add header 'Authorization: Basic b3N..3Jk', with b3N..3Jk as &quot;
                + &quot;'osUserName:osPassword' encoded in Base64 (use the Coder in jSQL to encode the string).&quot;
            );
        
<span class="pc bpc" id="L177" title="1 of 2 branches missed.">        } else if (this.isNtlm(responseCode, mapResponse)) {</span>
            
<span class="nc" id="L179">            LOGGER.log(</span>
                LogLevelUtil.CONSOLE_ERROR,
                &quot;NTLM Authentication detected: &quot;
                + &quot;set authentication in preferences, &quot;
                + &quot;or add username, password and domain information to the URL, e.g. http://domain\\user:password@127.0.0.1/[..]&quot;
            );
        
<span class="fc bfc" id="L186" title="All 2 branches covered.">        } else if (this.isDigest(responseCode, mapResponse)) {</span>
            
<span class="fc" id="L188">            LOGGER.log(</span>
                LogLevelUtil.CONSOLE_ERROR,
                &quot;Digest Authentication detected: set authentication in preferences.&quot;
            );
        
<span class="pc bpc" id="L193" title="1 of 2 branches missed.">        } else if (this.isNegotiate(responseCode, mapResponse)) {</span>
            
<span class="nc" id="L195">            LOGGER.log(</span>
                LogLevelUtil.CONSOLE_ERROR,
                &quot;Negotiate Authentication detected: &quot;
                + &quot;add username, password and domain information to the URL, e.g. http://domain\\user:password@127.0.0.1/[..]&quot;
            );
            
<span class="pc bpc" id="L201" title="1 of 2 branches missed.">        } else if (Pattern.matches(&quot;1\\d\\d&quot;, responseCode)) {</span>
            
<span class="nc" id="L203">            LOGGER.log(LogLevelUtil.CONSOLE_DEFAULT, &quot;{} {} Informational&quot;, FOUND_STATUS_HTTP, responseCode);</span>
            
<span class="fc bfc" id="L205" title="All 2 branches covered.">        } else if (Pattern.matches(&quot;2\\d\\d&quot;, responseCode)) {</span>
            
<span class="fc" id="L207">            LOGGER.log(LogLevelUtil.CONSOLE_SUCCESS, &quot;{} {} Success&quot;, FOUND_STATUS_HTTP, responseCode);</span>
            
<span class="pc bpc" id="L209" title="1 of 2 branches missed.">        } else if (Pattern.matches(&quot;3\\d\\d&quot;, responseCode)) {</span>
            
<span class="nc" id="L211">            LOGGER.log(LogLevelUtil.CONSOLE_ERROR, &quot;{} {} Redirection&quot;, FOUND_STATUS_HTTP, responseCode);</span>
            
<span class="nc bnc" id="L213" title="All 2 branches missed.">            if (!this.injectionModel.getMediatorUtils().getPreferencesUtil().isFollowingRedirection()) {</span>
                
<span class="nc" id="L215">                LOGGER.log(LogLevelUtil.CONSOLE_ERROR, &quot;If injection fails retry with option 'Follow HTTP redirection' activated&quot;);</span>
                
            } else {
                
<span class="nc" id="L219">                LOGGER.log(LogLevelUtil.CONSOLE_INFORM, &quot;Redirecting to the next page...&quot;);</span>
            }
            
<span class="fc bfc" id="L222" title="All 2 branches covered.">        } else if (Pattern.matches(REGEX_HTTP_STATUS, responseCode)) {</span>
            
<span class="fc" id="L224">            LOGGER.log(LogLevelUtil.CONSOLE_ERROR, &quot;{} {} Client Error&quot;, FOUND_STATUS_HTTP, responseCode);</span>
            
<span class="pc bpc" id="L226" title="1 of 2 branches missed.">        } else if (Pattern.matches(&quot;5\\d\\d&quot;, responseCode)) {</span>
            
<span class="fc" id="L228">            LOGGER.log(LogLevelUtil.CONSOLE_ERROR, &quot;{} {} Server Error&quot;, FOUND_STATUS_HTTP, responseCode);</span>
            
        } else {
            
<span class="nc" id="L232">            LOGGER.log(LogLevelUtil.CONSOLE_DEFAULT, &quot;{} {} Unknown&quot;, FOUND_STATUS_HTTP, responseCode);</span>
        }
<span class="fc" id="L234">    }</span>
    
    private boolean isNegotiate(String responseCode, Map&lt;String, String&gt; mapResponse) {
        
<span class="fc" id="L238">        return</span>
<span class="fc bfc" id="L239" title="All 2 branches covered.">            Pattern.matches(REGEX_HTTP_STATUS, responseCode)</span>
<span class="pc bpc" id="L240" title="1 of 2 branches missed.">            &amp;&amp; mapResponse.containsKey(WWW_AUTHENTICATE_RESPONSE)</span>
<span class="pc bnc" id="L241" title="All 2 branches missed.">            &amp;&amp; &quot;Negotiate&quot;.equals(mapResponse.get(WWW_AUTHENTICATE_RESPONSE));</span>
    }

    private boolean isDigest(String responseCode, Map&lt;String, String&gt; mapResponse) {
        
<span class="fc" id="L246">        return</span>
<span class="fc bfc" id="L247" title="All 2 branches covered.">            Pattern.matches(REGEX_HTTP_STATUS, responseCode)</span>
<span class="fc bfc" id="L248" title="All 2 branches covered.">            &amp;&amp; mapResponse.containsKey(WWW_AUTHENTICATE_RESPONSE)</span>
<span class="pc bpc" id="L249" title="1 of 2 branches missed.">            &amp;&amp; mapResponse.get(WWW_AUTHENTICATE_RESPONSE) != null</span>
<span class="pc bpc" id="L250" title="1 of 2 branches missed.">            &amp;&amp; mapResponse.get(WWW_AUTHENTICATE_RESPONSE).startsWith(&quot;Digest &quot;);</span>
    }

    private boolean isNtlm(String responseCode, Map&lt;String, String&gt; mapResponse) {
        
<span class="fc" id="L255">        return</span>
<span class="fc bfc" id="L256" title="All 2 branches covered.">            Pattern.matches(REGEX_HTTP_STATUS, responseCode)</span>
<span class="fc bfc" id="L257" title="All 2 branches covered.">            &amp;&amp; mapResponse.containsKey(WWW_AUTHENTICATE_RESPONSE)</span>
<span class="pc bpc" id="L258" title="1 of 2 branches missed.">            &amp;&amp; &quot;NTLM&quot;.equals(mapResponse.get(WWW_AUTHENTICATE_RESPONSE));</span>
    }

    private boolean isBasicAuth(String responseCode, Map&lt;String, String&gt; mapResponse) {
        
<span class="fc" id="L263">        return</span>
<span class="fc bfc" id="L264" title="All 2 branches covered.">            Pattern.matches(REGEX_HTTP_STATUS, responseCode)</span>
<span class="fc bfc" id="L265" title="All 2 branches covered.">            &amp;&amp; mapResponse.containsKey(WWW_AUTHENTICATE_RESPONSE)</span>
<span class="pc bpc" id="L266" title="1 of 2 branches missed.">            &amp;&amp; mapResponse.get(WWW_AUTHENTICATE_RESPONSE) != null</span>
<span class="pc bpc" id="L267" title="1 of 2 branches missed.">            &amp;&amp; mapResponse.get(WWW_AUTHENTICATE_RESPONSE).startsWith(&quot;Basic &quot;);</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>